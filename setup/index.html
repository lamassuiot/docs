
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../img/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.14">
    
    
      
        <title>Install Lamassu Compose - Lamassu IoT Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3de6f41f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/scheme.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="lamassu" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#install-lamassu-compose" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Lamassu IoT Docs" class="md-header__button md-logo" aria-label="Lamassu IoT Docs" data-md-component="logo">
      
  <img src="../img/lamassu.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lamassu IoT Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Install Lamassu Compose
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="lamassu" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Lamassu IoT Docs" class="md-nav__button md-logo" aria-label="Lamassu IoT Docs" data-md-component="logo">
      
  <img src="../img/lamassu.svg" alt="logo">

    </a>
    Lamassu IoT Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welcome to Lamassu Iot Docs
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Install Lamassu Compose
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Install Lamassu Compose
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatic-deployment" class="md-nav__link">
    Automatic deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-deployment" class="md-nav__link">
    Manual deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-aws-and-azure-pki-connectors" class="md-nav__link">
    Deploy AWS and Azure PKI connectors
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../manage/" class="md-nav__link">
        Managing Lamassu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        Lamassu APIs
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../protocols/" class="md-nav__link">
        Protocols & Lamassu
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automatic-deployment" class="md-nav__link">
    Automatic deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manual-deployment" class="md-nav__link">
    Manual deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-aws-and-azure-pki-connectors" class="md-nav__link">
    Deploy AWS and Azure PKI connectors
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="install-lamassu-compose">Install Lamassu Compose</h1>
<p>Lamassu Compose is the official release containing the scripts and resources required to deploy all microservices such as the CA component, the VA component or the RA components to name a few. </p>
<h2 id="architecture">Architecture</h2>
<p>Lamassu Compose offers a SECURE deployment of the set of microservices required to manage an industrial PKI. The architecture presented on the following image reflects the interconnection of the different services mainly using the HTTP Protocol. The use of this deployment offers the following non functional requirements by leveraging the use of an API Gateway:</p>
<ul>
<li>
<p><strong>Centralized point of access</strong>: Each microservice listens on a different port which ends up being challenging for developers and users. With the use of the API Gateway, the user will always access the same host and port address. Port <code>80</code> for HTTP connections and port <code>443</code> for HTTPS connections.</p>
</li>
<li>
<p><strong>Authentication</strong>: In order to invoke any endpoint, the API Gateway enforces each request to present a JWT. Upon receiving an HTTP request, the gateway validates the presented token against the authentication server.</p>
</li>
<li><strong>Authorization</strong>: Another key aspect is enforcing an authorization schema. Lamassu has been configured in such way that only specific endpoints are accessible by non admin users.</li>
<li><strong>Tracing</strong>: Logging the life of an HTTP request can be helpful during the debugging process of such complex application. The tracing aspect eases this process by injecting a unique identifier to each request that is then printed out by each microservice logs.</li>
<li><strong>Mutual TLS authentication</strong>: As mentioned earlier the gateway acts as the traffic orchestrator knowing where each service is and redirecting the traffic accordingly. To prevent any unauthorized request as well as protecting the communications channel between the Gateway itself and the upstream service, the API Gateway initiates a mutual TLS connection to ensure such thing.</li>
</ul>
<p><img alt="Screenshot" src="../img/base-architecture.png" /></p>
<h2 id="requirements">Requirements</h2>
<ul>
<li><code>jq</code>. Get the latest version: <a href="https://stedolan.github.io/jq/download/">https://stedolan.github.io/jq/download/</a></li>
<li><code>docker</code> and <code>docker-compose</code>: Get the latest version: <a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a> and <a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></li>
<li>Have a working DNS server able to resolve the domain used during the installation process or add the following content to the <code>/etc/hosts</code> file, replacing the <code>dev.lamassu.io</code> domain with your own:
    <div class="highlight"><pre><span></span><code>127.0.0.1  dev.lamassu.io 
127.0.0.1  vault.dev.lamassu.io 
127.0.0.1  auth.dev.lamassu.io 
127.0.0.1  tracing.dev.lamassu.io 
127.0.0.1  consul.dev.lamassu.io 
</code></pre></div></li>
</ul>
<h2 id="setup">Setup</h2>
<h3 id="automatic-deployment">Automatic deployment</h3>
<ol>
<li>
<p>Clone the repository and get into the directory: 
    <div class="highlight"><pre><span></span><code>git clone https://github.com/lamassuiot/lamassu-compose &amp;&amp; cd lamassu-compose
</code></pre></div></p>
</li>
<li>
<p>Define the next secret environment variables by exporting the following variables.
    <div class="highlight"><pre><span></span><code>export DB_USER=&lt;DB_USER&gt; //Database user.
export DB_PASSWORD=&lt;DB_PASSWORD&gt; //Database user password.
</code></pre></div></p>
</li>
<li>
<p>Define the domain to be used by exporting the DOMAIN variable.
    <div class="highlight"><pre><span></span><code>export DOMAIN=dev.lamassu.io
</code></pre></div></p>
</li>
<li>
<p>Define the docker images tags to be used by exporting the following variables
    <div class="highlight"><pre><span></span><code>export LAMASSU_GATEWAY_DOCKER_IMAGE=lamasuiot/lamassu-gateway:latest
export LAMASSU_UI_DOCKER_IMAGE=lamasuiot/lamassu-ui:latest
export LAMASSU_DB_DOCKER_IMAGE=lamasuiot/lamassu-db:latest
export LAMASSU_AUTH_DOCKER_IMAGE=lamasuiot/lamassu-auth:latest
export LAMASSU_CA_DOCKER_IMAGE=lamasuiot/lamassu-ca:latest
export LAMASSU_DMS_ENROLLER_DOCKER_IMAGE=lamasuiot/lamassu-dms-enroller:latest
export LAMASSU_DEVICE_MANAGER_DOCKER_IMAGE=lamasuiot/lamassu-device-manager:latest
export LAMASSU_RABBITMQ_DOCKER_IMAGE=lamasuiot/lamassu-rabbitmq:latest
export LAMASSU_CLOUD_PROXY_DOCKER_IMAGE=lamasuiot/lamassu-cloud-proxy:latest
export LAMASSU_OCSP_DOCKER_IMAGE=lamasuiot/lamassu-ocsp:latest
</code></pre></div></p>
</li>
<li>
<p>Run the following command to replace <code>.env</code> file with the values defined variables previously:
    <div class="highlight"><pre><span></span><code>envsubst &lt; .env | tee .env
</code></pre></div></p>
</li>
<li>
<p>Run the installer:
    <div class="highlight"><pre><span></span><code>bash install.sh
</code></pre></div></p>
</li>
<li>
<p>(OPTIONAL) Import your certificates:</p>
<p>The <code>install.sh</code> script also generates self-signed for the downstream certificates. It is possible to provide other valid certificates by replacing the following files:
<div class="highlight"><pre><span></span><code>‚îú‚îÄ‚îÄ upstream
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ downstream
    ‚îú‚îÄ‚îÄ tls.crt     &lt;----- Provide your certificate
    ‚îî‚îÄ‚îÄ tls.key     &lt;----- Provide your private key
</code></pre></div></p>
<p>Once you replace this certificates, restart the api-gateway to obtain the imported certificates:</p>
<div class="highlight"><pre><span></span><code>docker-compose rm -s -f api-gateway dms-default
docker-compose up -d api-gateway dms-default
</code></pre></div>
</li>
<li>
<p>Final notes:</p>
<p>üöÄ You are ready to go üöÄ</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Keycloak is your auth provider. During the <code>install.sh</code> the service is provisioned with 2 users with different roles:
    <div class="highlight"><pre><span></span><code>Username: enroller
Password: enroller
Role: admin
</code></pre></div>
    <div class="highlight"><pre><span></span><code>Username: operator
Password: operator
Role: operator
</code></pre></div>
You can change those credentials (or create new users) using keycloak's UI available at: <code>https://auth.&lt;DOMAIN&gt;</code></p>
</div>
</li>
</ol>
<h3 id="manual-deployment">Manual deployment</h3>
<p>To launch Lamassu follow the next steps:</p>
<ol>
<li>
<p>Set up your environment:</p>
<ol>
<li>
<p>Clone the repository and get into the directory: 
    <div class="highlight"><pre><span></span><code>git clone https://github.com/lamassuiot/lamassu-compose &amp;&amp; cd lamassu-compose
</code></pre></div></p>
</li>
<li>
<p>Define the DB credentials variables used by the <code>.env</code> file.
    <div class="highlight"><pre><span></span><code>export DB_USER=&lt;DB_USER&gt; //Database user.
export DB_PASSWORD=&lt;DB_PASSWORD&gt; //Database user password.
</code></pre></div></p>
</li>
<li>
<p>Define the domain to be used by the <code>.env</code> file.
    <div class="highlight"><pre><span></span><code>export DOMAIN=dev.lamassu.io
</code></pre></div></p>
</li>
<li>
<p>Define the docker images tags to be used by exporting the following variables
    <div class="highlight"><pre><span></span><code>export LAMASSU_GATEWAY_DOCKER_IMAGE=lamasuiot/lamassu-gateway:latest
export LAMASSU_UI_DOCKER_IMAGE=lamasuiot/lamassu-ui:latest
export LAMASSU_DB_DOCKER_IMAGE=lamasuiot/lamassu-db:latest
export LAMASSU_AUTH_DOCKER_IMAGE=lamasuiot/lamassu-auth:latest
export LAMASSU_CA_DOCKER_IMAGE=lamasuiot/lamassu-ca:latest
export LAMASSU_DMS_ENROLLER_DOCKER_IMAGE=lamasuiot/lamassu-dms-enroller:latest
export LAMASSU_DEVICE_MANAGER_DOCKER_IMAGE=lamasuiot/lamassu-device-manager:latest
export LAMASSU_RABBITMQ_DOCKER_IMAGE=lamasuiot/lamassu-rabbitmq:latest
export LAMASSU_CLOUD_PROXY_DOCKER_IMAGE=lamasuiot/lamassu-cloud-proxy:latest
export LAMASSU_OCSP_DOCKER_IMAGE=lamasuiot/lamassu-ocsp:latest
</code></pre></div></p>
</li>
<li>
<p>Run the following command to replace <code>.env</code> file with the values defined variables previously:
    <div class="highlight"><pre><span></span><code>envsubst &lt; .env | tee .env
</code></pre></div></p>
</li>
</ol>
</li>
<li>
<p>The Gateway and TLS Certificates </p>
<p>Lamassu uses a Gateway to expose all the deployed services. Moreover, the gateway is in charge of performing the following tasks:
    - Routing traffic to services
    - Enforcing authentication policies
    - Enforcing authorization policies
    - Logging &amp; tracing
    - Healthchecking
    - Securely expose services using TLS</p>
<p>The different APIs exposed through the gateway have been configured to ONLY accept request originates inside the platform via a mTLS authentication:</p>
<div class="highlight"><pre><span></span><code>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇClient/Browser‚îÇ -&lt;downstream&gt;- ‚îÇ    Gateway    ‚îÇ -&lt;upstream&gt;- ‚îÇ     API     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       TLS      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      mTLS    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div>
<ol>
<li>
<p>Generate the upstream certificates. </p>
<div class="highlight"><pre><span></span><code>cd tls-certificates
./gen-upstream-certs.sh
</code></pre></div>
</li>
<li>
<p>There are 2 options for the downstream certificate:</p>
<ul>
<li>
<p><strong>Import an existing certificate</strong>: If you have valid certificates for your domain, you can use them by placing them under the <code>downstream</code> folder. The end result should be:
    <div class="highlight"><pre><span></span><code>‚îú‚îÄ‚îÄ upstream
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ downstream
    ‚îú‚îÄ‚îÄ tls.crt
    ‚îî‚îÄ‚îÄ tls.key
</code></pre></div></p>
</li>
<li>
<p><strong>Generate a Self Signed certificate</strong>: If you need to create a new self-signed certificate, run the following command:
    <div class="highlight"><pre><span></span><code>./gen-downstream-certs.sh
</code></pre></div></p>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>Authentication service configuration:</p>
<ol>
<li>Run Keycloak: 
    <div class="highlight"><pre><span></span><code>docker-compose up -d auth
</code></pre></div></li>
<li>
<p>Keycloak image is configured with a Realm, a client and two different roles: <code>admin</code> and <code>operator</code>.</p>
</li>
<li>
<p>Create a user with admin role to perform Enroller administrator tasks. (The command below creates a user named <strong>enroller</strong> with <strong>enroller</strong> as its password):
    <div class="highlight"><pre><span></span><code>docker-compose exec auth /opt/jboss/keycloak/bin/add-user-keycloak.sh -r lamassu -u enroller -p enroller --roles admin
</code></pre></div></p>
</li>
<li>
<p>Create a user with operator role to perform Device Manufacturing System tasks. This Device Manufacturing System must associate its CSR with this user matching the CN attribute and the username.(The command below creates a user named <strong>operator</strong> with <strong>operator</strong> as its password):
    <div class="highlight"><pre><span></span><code>docker-compose exec auth /opt/jboss/keycloak/bin/add-user-keycloak.sh -r lamassu -u operator -p operator --roles operator
</code></pre></div></p>
</li>
<li>
<p>Reload keyclok server
    <div class="highlight"><pre><span></span><code>docker-compose exec auth /opt/jboss/keycloak/bin/jboss-cli.sh --connect command=:reload
</code></pre></div></p>
</li>
<li>
<p>If Keycloak display the following output, keycloak has successfully reloaded. Otherwise, run the command again until you see the expected output:
<div class="highlight"><pre><span></span><code>{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; undefined
}
</code></pre></div></p>
</li>
<li>Provision and configure Vault and Lamassu CA:</li>
<li>Run Vault: 
    <div class="highlight"><pre><span></span><code>docker-compose up -d vault consul-server api-gateway
</code></pre></div></li>
<li>Initialize vault: This process generates vault's unseal keys as well as the root token:
    <div class="highlight"><pre><span></span><code>docker-compose exec vault vault operator init -key-shares=5 -key-threshold=3 -tls-skip-verify -format=json &gt; vault-credentials.json
</code></pre></div></li>
<li>
<p>Verify the <code>vault-credentials.json</code> file has the expected content. It should be similar to this:
    <div class="highlight"><pre><span></span><code>{
    &quot;unseal_keys_b64&quot;: [
        &quot;Hfx46iMq/PXoBPhDZ0EAMM9MDWS8GTCANFbAkzVEzFOD&quot;,
        &quot;lfo48PHGFGHmpaFn6Z6rWTXTXVS53m9duxsvwVjRDc2L&quot;,
        &quot;dcVw6N81i+/pY34WTHQYkV848to7jNeVkgdJOtgxnRkS&quot;,
        &quot;Aut6oL7+GomXCrrTH0FCKhJwAs2PrWFYSnWpgjLfwsH0&quot;,
        &quot;pprFM0HJEUR4m3kaIT5sga87aJ4AjXi32KVn6dgfivii&quot;
    ],
    &quot;unseal_keys_hex&quot;: [
        &quot;1dfc78ea232afcf5e804f84367410030cf4c0d64bc1930803456c0933544cc5383&quot;,
        &quot;95fa38f0f1c61461e6a5a167e99eab5935d35d54b9de6f5dbb1b2fc158d10dcd8b&quot;,
        &quot;75c570e8df358befe9637e164c7418915f38f2da3b8cd7959207493ad8319d1912&quot;,
        &quot;02eb7aa0befe1a89970abad31f41422a127002cd8fad61584a75a98232dfc2c1f4&quot;,
        &quot;a69ac53341c91144789b791a213e6c81af3b689e008d78b7d8a567e9d81f8af8a2&quot;
    ],
    &quot;unseal_shares&quot;: 5,
    &quot;unseal_threshold&quot;: 3,
    &quot;recovery_keys_b64&quot;: [],
    &quot;recovery_keys_hex&quot;: [],
    &quot;recovery_keys_shares&quot;: 5,
    &quot;recovery_keys_threshold&quot;: 3,
    &quot;root_token&quot;: &quot;s.80Mpm0OmxlXzoSxZB2MMPcNu&quot;
}
</code></pre></div></p>
</li>
<li>
<p>Export the following variables:
    <div class="highlight"><pre><span></span><code>export VAULT_TOKEN=$(cat vault-credentials.json | jq .root_token -r)
export VAULT_ADDR=https://vault.$DOMAIN
</code></pre></div></p>
</li>
<li>
<p>Unseal Vault using the keys obtained with the previous command:
    <div class="highlight"><pre><span></span><code>curl --request PUT &quot;$VAULT_ADDR/v1/sys/unseal&quot; -k --header &#39;Content-Type: application/json&#39; --data-raw &quot;{\&quot;key\&quot;: \&quot;$(cat vault-credentials.json | jq -r .unseal_keys_hex[0])\&quot; }&quot;
curl --request PUT &quot;$VAULT_ADDR/v1/sys/unseal&quot; -k --header &#39;Content-Type: application/json&#39; --data-raw &quot;{\&quot;key\&quot;: \&quot;$(cat vault-credentials.json | jq -r .unseal_keys_hex[1])\&quot; }&quot;
curl --request PUT &quot;$VAULT_ADDR/v1/sys/unseal&quot; -k --header &#39;Content-Type: application/json&#39; --data-raw &quot;{\&quot;key\&quot;: \&quot;$(cat vault-credentials.json | jq -r .unseal_keys_hex[2])\&quot; }&quot;
</code></pre></div></p>
</li>
<li>
<p>Vault must be provisioned with some resources (authentication methods, policies and secret engines). That can be achieved by running the <code>ca-provision.sh</code> script. Vault will be provisioned with 4 Root CAs, 1 Special CA (Lamassu-DMS-Enroller) AppRole authentication method and one role and policy for each service or container that needs to exchange data with it. </p>
<div class="highlight"><pre><span></span><code>cd config/vault/provision/
./provisioner.sh
cd ../../../
</code></pre></div>
</li>
<li>
<p>Get RoleID and SecretID for each service and set those values in the empty fields of the <code>.docker-compose.yml</code> file.
    <div class="highlight"><pre><span></span><code>export CA_VAULT_ROLEID=$(curl -k --header &quot;X-Vault-Token: ${VAULT_TOKEN}&quot; ${VAULT_ADDR}/v1/auth/approle/role/lamassu-ca-role/role-id | jq -r .data.role_id )
export CA_VAULT_SECRETID=$(curl -k --header &quot;X-Vault-Token: ${VAULT_TOKEN}&quot; --request POST ${VAULT_ADDR}/v1/auth/approle/role/lamassu-ca-role/secret-id | jq -r .data.secret_id)

# Set RoleID and SecretID in docker-compose.yml file
sed -i &#39;s/&lt;LAMASSU_CA_VAULT_ROLE_ID&gt;/&#39;$CA_VAULT_ROLEID&#39;/g&#39; docker-compose.yml
sed -i &#39;s/&lt;LAMASSU_CA_VAULT_SECRET_ID&gt;/&#39;$CA_VAULT_SECRETID&#39;/g&#39; docker-compose.yml
</code></pre></div></p>
</li>
</ol>
</li>
<li>
<p>Configure the Device Manager:</p>
<ol>
<li>The Device Manage has a configurable variable that determines when a device can renew (also known as reenroll) its certificate. By default the reenrollment process can only be done 30 days prior to the cert's expiration time. This value can be changed by modifying the <code>DEVICE_MANAGER_MINIMUM_REENROLL_DAYS</code> variable located in the <code>.env</code> file.</li>
</ol>
</li>
<li>
<p>Start the remaining services:
    <div class="highlight"><pre><span></span><code>docker-compose up -d
</code></pre></div></p>
</li>
<li>
<p>Configure the <code>Default DMS</code></p>
<ol>
<li>First, authenticate against Keycloak:
    <div class="highlight"><pre><span></span><code>export AUTH_ADDR=auth.$DOMAIN

export TOKEN=$(curl -k --location --request POST &quot;https://$AUTH_ADDR/auth/realms/lamassu/protocol/openid-connect/token&quot; --header &#39;Content-Type: application/x-www-form-urlencoded&#39; --data-urlencode &#39;grant_type=password&#39; --data-urlencode &#39;client_id=frontend&#39; --data-urlencode &#39;username=enroller&#39; --data-urlencode &#39;password=enroller&#39; |jq -r .access_token)
</code></pre></div></li>
<li>
<p>Then, register a new DMS named Lamassu-Default-DMS:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>while registering new DMS instances with non admin users, it is necessary to register the DMS using the user's username as the common name, otherwise, the user won't see its DMSs    </p>
</div>
<p><div class="highlight"><pre><span></span><code>export ENROLL_ADDR=$DOMAIN/api/dmsenroller
export DMS_REGISTER_RESPONSE=$(curl -k --location --request POST &quot;https://$ENROLL_ADDR/v1/Lamassu-Default-DMS/form&quot; --header &quot;Authorization: Bearer ${TOKEN}&quot; --header &#39;Content-Type: application/json&#39; --data-raw &quot;{\&quot;url\&quot;:\&quot;https://${DOMAIN}:5000\&quot;, \&quot; subject\&quot;:{ \&quot;common_name\&quot;: \&quot;Lamassu-Default-DMS\&quot;,\&quot;country\&quot;: \&quot;\&quot;,\&quot;locality\&quot;: \&quot;\&quot;,\&quot;organization\&quot;: \&quot;\&quot;,\&quot;organization_unit\&quot;: \&quot;\&quot;,\&quot;state\&quot;: \&quot;\&quot;},\&quot;key_metadata\&quot;:{\&quot;bits\&quot;: 3072,\&quot;type\&quot;: \&quot;rsa\&quot;}}&quot;)

echo $DMS_REGISTER_RESPONSE | jq -r .priv_key | sed &#39;s/\\n/\n/g&#39; | sed -Ez &#39;$ s/\n+$//&#39; | base64 -d &gt; lamassu-default-dms/config/dms.key
export DMS_ID=$(echo $DMS_REGISTER_RESPONSE | jq -r .dms.id)
</code></pre></div>
    3. Enroll the new DMS
<div class="highlight"><pre><span></span><code>curl -k --location --request PUT &quot;https://$ENROLL_ADDR/v1/$DMS_ID&quot; --header &quot;Authorization: Bearer $TOKEN&quot; --header &#39;Content-Type: application/json&#39; --data-raw &#39;{&quot;status&quot;: &quot;APPROVED&quot;}&#39;
</code></pre></div>
    4. Get issued DMS Cert
<div class="highlight"><pre><span></span><code>curl -k --location --request GET &quot;https://$ENROLL_ADDR/v1/$DMS_ID/crt&quot; --header &quot;Authorization: Bearer $TOKEN&quot; | base64 -d &gt; lamassu-default-dms/config/dms.crt
</code></pre></div></p>
</li>
<li>
<p>And finally, start the DMS "server":
    <div class="highlight"><pre><span></span><code>docker-compose rm -s -f dms-default
docker-compose up -d dms-default
</code></pre></div></p>
</li>
</ol>
</li>
</ol>
<h2 id="deploy-aws-and-azure-pki-connectors">Deploy AWS and Azure PKI connectors</h2>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Welcome to Lamassu Iot Docs" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Welcome to Lamassu Iot Docs
            </div>
          </div>
        </a>
      
      
        
        <a href="../manage/" class="md-footer__link md-footer__link--next" aria-label="Next: Managing Lamassu" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Managing Lamassu
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/lamassuiot" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://hub.docker.com/u/lamassuiot" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/lamassuiot" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c2e1ee47.min.js"></script>
      
    
  </body>
</html>